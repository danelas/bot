# Setting Up Google Sheets Integration

This guide will help you set up Google Sheets integration for storing conversation history between users and your OpenAI Assistant.

## Step 1: Create a Google Cloud Project

1. Go to the [Google Cloud Console](https://console.cloud.google.com/)
2. Click on the project dropdown and select "New Project"
3. Name your project (e.g., "Facebook Chatbot") and click "Create"
4. Make sure your new project is selected in the dropdown

## Step 2: Enable the Google Sheets API

1. In the Google Cloud Console, navigate to "APIs & Services" > "Library"
2. Search for "Google Sheets API"
3. Click on "Google Sheets API" and then click "Enable"
4. Also search for and enable "Google Drive API" (required for the Sheets API to work properly)

## Step 3: Create Service Account Credentials

1. In the Google Cloud Console, navigate to "APIs & Services" > "Credentials"
2. Click "Create Credentials" and select "Service Account"
3. Fill in the service account details:
   - Name: "Facebook Chatbot Service Account"
   - ID: (auto-generated or choose your own)
   - Description: "Service account for Facebook chatbot integration with Google Sheets"
4. Click "Create and Continue"
5. For "Grant this service account access to project", select "Editor" role
6. Click "Continue" and then "Done"

## Step 4: Create and Download the JSON Key

1. In the service accounts list, click on your newly created service account
2. Go to the "Keys" tab
3. Click "Add Key" > "Create new key"
4. Select "JSON" as the key type and click "Create"
5. The JSON key file will be automatically downloaded to your computer
6. Rename this file to `google_credentials.json`

## Step 5: Create a Google Sheet

1. Go to [Google Sheets](https://sheets.google.com/)
2. Create a new spreadsheet
3. Give it a name like "Facebook Chatbot Conversations"
4. Note: You don't need to add any headers as the application will set them up automatically

## Step 6: Share the Sheet with the Service Account

1. In your Google Sheet, click the "Share" button in the top-right corner
2. In the "Add people and groups" field, paste the email address of your service account
   - This will look something like `service-account-name@project-id.iam.gserviceaccount.com`
   - You can find this email in the service account details page
3. Make sure the service account has "Editor" access
4. Uncheck "Notify people" and click "Share"

## Step 7: Get the Sheet ID

1. Look at the URL of your Google Sheet
2. The Sheet ID is the long string of characters in the URL between `/d/` and `/edit`
   - For example, in `https://docs.google.com/spreadsheets/d/1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3/edit`, 
   - the Sheet ID would be `1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3`

## Step 8: Configure Environment Variables

1. Place the `google_credentials.json` file in the root directory of your project
2. In your `.env` file, add:
   ```
   GOOGLE_SHEETS_CREDENTIALS_FILE=google_credentials.json
   GOOGLE_SHEETS_ID=your_sheet_id_from_step_7
   ```

## Testing the Integration

You can test if your Google Sheets integration is working by running the test script:

```bash
python test_assistant.py
```

If configured correctly, this will:
1. Allow you to chat with your OpenAI Assistant
2. Save each conversation to your Google Sheet

## Troubleshooting

If you encounter issues with the Google Sheets integration:

1. **Permission errors**: Make sure the service account has editor access to the sheet
2. **Authentication errors**: Verify that the credentials file is correctly placed and referenced in the `.env` file
3. **API not enabled**: Ensure both the Google Sheets API and Google Drive API are enabled
4. **Rate limiting**: Google APIs have quotas. If you hit limits, consider implementing exponential backoff in your code

## Sheet Structure

Once set up, your Google Sheet will have the following columns:

1. **Timestamp**: When the message was sent/received
2. **User ID**: Facebook user ID
3. **User Name**: User's name from Facebook profile
4. **User Message**: The message sent by the user
5. **Assistant Response**: The response generated by your OpenAI Assistant
6. **Platform**: The platform the message was sent from (always "Facebook" for this integration)
7. **Thread ID**: The OpenAI thread ID for continuity of conversation
