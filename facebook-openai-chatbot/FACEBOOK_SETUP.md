# Setting Up Facebook Messenger Integration

This guide will help you configure your Facebook Page and Messenger integration for the chatbot.

## Step 1: Create a Facebook Page

If you don't already have a Facebook Page:

1. Go to [Facebook](https://www.facebook.com/)
2. Click on "Pages" in the left sidebar
3. Click "Create New Page"
4. Follow the steps to set up your page with a name, category, and description
5. Add a profile picture and cover photo

## Step 2: Create a Facebook Developer Account

1. Go to [Facebook for Developers](https://developers.facebook.com/)
2. Sign in with your Facebook account
3. Complete the registration process if you haven't already

## Step 3: Create a Facebook App

1. Go to the [Facebook Developers Dashboard](https://developers.facebook.com/apps/)
2. Click "Create App"
3. Select "Business" as the app type
4. Fill in the app name and contact email
5. Click "Create App"

## Step 4: Add Messenger to Your App

1. In your new app's dashboard, click "Add Products" in the left sidebar
2. Find "Messenger" and click "Set Up"

## Step 5: Configure Messenger Settings

1. In the left sidebar, click on "Messenger" > "Settings"
2. Under "Access Tokens", click "Add or Remove Pages"
3. Select your Facebook Page and follow the prompts to connect it
4. Once connected, click "Generate Token" next to your page
5. Copy this Page Access Token - you'll need it for your `.env` file

## Step 6: Set Up Webhooks

Before setting up webhooks, make sure your application is deployed to a server with HTTPS support. For testing, you can use ngrok:

```bash
ngrok http 5000
```

Then:

1. In your Facebook app dashboard, under Messenger > Settings
2. Scroll to "Webhooks" and click "Add Callback URL"
3. Enter your webhook URL (e.g., `https://your-domain.com/webhook` or your ngrok URL + `/webhook`)
4. Enter your verification token (this should match the `FACEBOOK_VERIFY_TOKEN` in your `.env` file)
5. Click "Verify and Save"

## Step 7: Subscribe to Webhook Events

1. After verifying your webhook, click "Add Subscriptions" for your page
2. Select the following fields:
   - messages
   - messaging_postbacks
   - messaging_optins
   - message_deliveries
   - message_reads
3. Click "Save"

## Step 8: Configure App Permissions

1. In your app dashboard, go to "App Review" > "Permissions and Features"
2. Request permissions for:
   - `pages_messaging`
   - `pages_read_engagement`
3. You'll need to provide details on how your app uses these permissions
4. Submit for review

Note: While in development mode, your app can message only developers and testers of your app.

## Step 9: Add Environment Variables

Add the following to your `.env` file:

```
FACEBOOK_APP_ID=your_app_id
FACEBOOK_APP_SECRET=your_app_secret
FACEBOOK_PAGE_ACCESS_TOKEN=your_page_access_token
FACEBOOK_VERIFY_TOKEN=your_verification_token
```

## Testing Your Integration

1. Make sure your app is deployed and running
2. Message your Facebook Page
3. You should receive a response generated by your OpenAI Assistant
4. Check your server logs for any errors
5. Verify that conversations are being saved to Google Sheets

## Going Live

To make your chatbot available to the public:

1. Complete the App Review process with Facebook
2. Once approved, go to your app dashboard
3. At the top of the page, switch the toggle from "Development" to "Live"

## Advanced Configuration

### Welcome Message

To set up a welcome message when users first interact with your page:

1. In your app dashboard, go to Messenger > Settings
2. Under "Customer Chat Plugin", click "Set Up"
3. Configure your welcome message

### Persistent Menu

To add a persistent menu with quick actions:

1. Use the Graph API to set up a persistent menu
2. Example code:

```python
def setup_persistent_menu():
    url = f"https://graph.facebook.com/v17.0/me/messenger_profile"
    params = {"access_token": FACEBOOK_PAGE_ACCESS_TOKEN}
    headers = {"Content-Type": "application/json"}
    
    data = {
        "persistent_menu": [
            {
                "locale": "default",
                "composer_input_disabled": False,
                "call_to_actions": [
                    {
                        "type": "postback",
                        "title": "Help",
                        "payload": "HELP_PAYLOAD"
                    },
                    {
                        "type": "web_url",
                        "title": "Visit Website",
                        "url": "https://your-website.com",
                        "webview_height_ratio": "full"
                    }
                ]
            }
        ]
    }
    
    response = requests.post(
        url,
        params=params,
        headers=headers,
        json=data
    )
    return response.json()
```

You can add this function to your application and call it during setup.
